<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<title>goHome</title>
	<meta name="description" content="goHome">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" type="text/css" title="main" href="css/main.css">
	
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery.json.min.js"></script>
	<script src="https://unpkg.com/vue/dist/vue.js"></script>
	
	<script>

	var vm = {};

	function getObjVal(obj,key){
		var fieldId=0;
		for (i = 0; i < obj.Fields.length; i++) {
			if (obj.Fields[i].Name == key) {
				fieldId = obj.Fields[i].IdField;
				break;
			}
		}
		if ( fieldId==0 ) {
			return '';
		}
		for (i = 0; i < obj.Values.length; i++) {
			if (obj.Values[i].IdField == fieldId) {
				return obj.Values[i].Val;
			}
		}
		return '';
	};


	function callServer(action,cmde){
		$.post("/api",
		{
			command:$.toJSON(cmde)
		},
		function(data, status){
			if (action == 1) {
				vm.actorsList = $.parseJSON(data);
				$("#test").html('<br><br>'+getObjVal(vm.actorsList[0],'Name')+'<br><br>');
			} else if (action == 2)  {
				vm.imgSensorList = $.parseJSON(data);
			} else if (action == 100)  {
				alert(cmde.command + '(' + data + ')' );
			}
		});
	};

//	$(function () {
//	});



	$(document).ready(function(){
		var tst1 = [{id:1,val:'un'},{id:2,val:'deux'},{id:3,val:'trois'}];
		var tst2 = [{id:10,val:'dix'},{id:20,val:'vingt'},{id:30,val:'trente'}];
		Vue.component('tst-un', {
			props: ['bidon'],
			template: '<span v-on:click="bidact" v-bind:id="bidon.id"> {{ bidon.id }} {{ bidon.val }} </span>',
			methods: {
				bidact: function (event) {
					  if (event.target.id < 10) {
						vm.bidonList = tst2;
					} else {
						vm.bidonList = tst1;
					}
				}
			}
		});

		Vue.component('std-actors', {
			props: ['actor'],
			template: ' <span class="ico" v-bind:id="actor.Values[0].IdObject" v-on:click="actionner" > {{actor.Values[1].Val}} \
					<img v-bind:id="actor.Values[0].IdObject" v-bind:src="actor.Values[0].Val"  class="icone" /></span>',
			methods: {
				actionner: function (event) {
//	TODO : CONFIRMATION + input param				alert('Actionner ' + event.target.name + ' - ' + event.target.id)
					callServer(100,{
						command:'TriggerActor', 
						itemtypeid:0,
						itemid:0,
						objectid:parseInt(event.target.id),
						startts:0,
						endts:0,
						jsonparam:''
					});
				}
			}
		});

		Vue.component('img-sensor', {
			props: ['imgsensor'],
			template: ' <span class="ico" v-bind:id="imgsensor.Values[0].IdObject" v-on:click="readImg" > {{imgsensor.Values[1].Val}} \
					<img v-bind:id="imgsensor.Values[0].IdObject" v-bind:src="imgsensor.Values[0].Val"  class="icone" /></span>',
			methods: {
				readImg: function (event) {
					var url='/nexus/photo.jpg?x='+Math.random();
					$("#showLoad").show();
					$.get(url, {}, function(data, status) { 
						$("#showLoad").hide(); 
						$("#showImg").show();
						vm.imgSensorSrc = url; 
					});
				}
			}
		});

		Vue.component('img-sensor-show', {
			props: ['imgsensorsrc'],
// TODO : Ajouter Titre + Save + X (close)
			template: ' <div id="showImg" class="imgsensor blackbox" v-on:click="hideImg" ><img v-bind:src="imgsensorsrc" class="imgsensor"/></div>',
			methods: {
				hideImg: function (event) {
					  $("#showImg").hide();
				},
				hideLoad: function (event) {
					  $("#showLoad").hide();
				}
			}
		});

		vm = new Vue({
			el: '#gohome',
			data: {
				bidonList: [],
				actorsList: [],
				imgSensorList: [],
				imgSensorSrc:'/images/PlageMoorea.jpg'
			}
		});

		callServer(1,{
			command:'ReadObject', 
			itemtypeid:3,
			itemid:0,
			objectid:0,
			startts:0,
			endts:0,
			jsonparam:''
		});
		callServer(2,{
			command:'ReadObject', 
			itemtypeid:5,
			itemid:0,
			objectid:0,
			startts:0,
			endts:0,
			jsonparam:''
		});
		$("#showLoad").hide();
		$("#showImg").hide();

	});
	</script>
</head>
</head>
<body>
<center>
<h1>Welcome</h1>

<div id="gohome">
	<std-actors v-for="i in actorsList" v-bind:actor="i"></std-actors>
	<img-sensor v-for="j in imgSensorList" v-bind:imgsensor="j"></img-sensor>
	
	<img-sensor-show v-bind:imgsensorsrc=imgSensorSrc></img-sensor-show>
	
	<tst-un v-for="k in bidonList" v-bind:bidon="k"></tst-un>
	
</div>
<div id="showLoad" class="imgsensor blackbox" onclick='$("#showLoad").hide();' ><img src="/images/loading.gif" class="imgloading"/></div>'


<div id="test" class="test">
	
</div>



</center>
</body>
</html>


