<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<title>goHome</title>
	<meta name="description" content="goHome">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" type="text/css" title="main" href="css/main.css">
	
	<script src="js/jquery.min.js"></script>
	<script src="js/jquery.json.min.js"></script>
	<script src="js/vue.min.js"></script>

	<link rel="stylesheet" href="https://unpkg.com/mint-ui/lib/style.css">
	<script src="https://unpkg.com/mint-ui/lib/index.js"></script>

	<script>

	var vm = {};

	function loadAll(){
		// TODO load User info from server

		// Read actors
		callServer(1,{
			command:'ReadObject', 
			itemtypeid:3,
			itemid:0,
			objectid:0,
			startts:0,
			endts:0,
			jsonparam:''
		});

		// Read img sensors
		callServer(2,{
			command:'ReadObject', 
			itemtypeid:5,
			itemid:0,
			objectid:0,
			startts:0,
			endts:0,
			jsonparam:''
		});
	};

	function getObjVal(obj,key){
		var fieldId=0;
		for (i = 0; i < obj.Fields.length; i++) {
			if (obj.Fields[i].Name == key) {
				fieldId = obj.Fields[i].IdField;
				break;
			}
		}
		if ( fieldId==0 ) {
			return '';
		}
		for (i = 0; i < obj.Values.length; i++) {
			if (obj.Values[i].IdField == fieldId) {
				return obj.Values[i].Val;
			}
		}
		return '';
	};


	function callServer(action,cmde){
		$.post("/api",
		{
			command:$.toJSON(cmde)
		},
		function(data, status){
			if (action == 1) {
				vm.actorsList = $.parseJSON(data);
//				$("#test").html('<br><br>'+getObjVal(vm.actorsList[0],'Name')+'<br><br>');
			} else if (action == 2)  {
				vm.imgSensorList = $.parseJSON(data);
			} else if (action == 100)  {
				vm.$toast(cmde.command + '(' + data + ')' );
			}
		});
	};


	$(document).ready(function(){

		Vue.component('std-actors', {
			props: ['actor'],
			template: ' <span class="ico" v-bind:id="actor.Values[0].IdObject" v-on:click="actionner" >  {{getObjVal(actor,"Name")}} \
					<img v-bind:id="actor.Values[0].IdObject" v-bind:src="getObjVal(actor,\'ImgFileName\')" class="icone" /></span>',
			methods: {
				actionner: function (event) {
					var curActor=vm.getObjById(vm.actorsList,event.target.id);
					var showI = ( vm.getObjVal(curActor,'DynParamType')  != '0' );
					var options={confirmButtonText:'Confirmer', cancelButtonText:'Annuler', showInput: showI };
					vm.$messagebox.prompt('Actionner '+ vm.getObjVal(curActor,'Name') + ' ?',options).then(({ value, action }) => {
						callServer(100,{
							command:'TriggerActor', 
							itemtypeid:0,
							itemid:0,
							objectid:parseInt(event.target.id),
							startts:0,
							endts:0,
							jsonparam:value
						});
					});
				}
			}
		});

		Vue.component('img-sensor', {
			props: ['imgsensor'],
			template: ' <span class="ico" v-bind:id="imgsensor.Values[0].IdObject" v-on:click="readImg" > {{getObjVal(imgsensor,"Name")}} \
					<img v-bind:id="imgsensor.Values[0].IdObject" v-bind:src="getObjVal(imgsensor,\'ImgFileName\')"  class="icone" /></span>',
			methods: {
				readImg: function (event) {
					$("#showImg").show();
					vm.imgSensorSrc = '/images/PlageMoorea2.jpg'; 

					var obj=vm.getObjById(vm.imgSensorList,event.target.id);
					var url=vm.getObjVal(obj,'Param');
					if ( url == '' ) {
						vm.$toast('URL invalide pour Image sensor ' + event.target.id);
						$("#showImg").hide();
					} else {
						setTimeout(function() { vm.imgSensorSrc = url; }, 100); // For some raison (?) with setTimeout we avoid image caching
						vm.imgSensorSrc = url;  // TODO sometime the img is not upload/diplay
					}
				}
			}
		});

		Vue.component('img-sensor-show', {
			props: ['imgsensorsrc'],
			template: '<div id="showImg" class="imgsensor"><img v-bind:src="imgsensorsrc" class="imgsensor"/><div class="bottomdiv"  v-on:click="hideImg" > Close {{imgsensorsrc}} </div></div>', 
			methods: {
				hideImg: function (event) {
					vm.imgSensorSrc = '/images/PlageMoorea.jpg'; 
					$("#showImg").hide();
				}
				// TODO : Save img 
			}
		});


		// -----------------------------------------------------------------------------------------------------------------------------------------

		vm = new Vue({
			el: '#gohome',
			data: {
				bidonList: [],
				actorsList: [],
				imgSensorList: [],
				imgSensorSrc: 'images/PlageMoorea.jpg',
				curImgSensor:{},
			},
			methods: {
				handleClick: function() {
					this.$toast('Hello world!')
				},
				getObjById: function(obj,id){
					for (i = 0; i < obj.length; i++) {
						if (obj[i].Values[0].IdObject == id) {
							return obj[i];
						}
					}
					return {Fiels:[], Values:[]};
				},
				getObjVal: function(obj,key){
					var fieldId=0;
					for (i = 0; i < obj.Fields.length; i++) {
						if (obj.Fields[i].Name == key) {
							fieldId = obj.Fields[i].IdField;
							break;
						}
					}
					if ( fieldId==0 ) {
						return '';
					}
					for (i = 0; i < obj.Values.length; i++) {
						if (obj.Values[i].IdField == fieldId) {
							return obj.Values[i].Val;
						}
					}
					return '';
				}
			}
		});



		loadAll();

		$("#showImg").hide();


	});
	</script>
</head>
</head>
<body class="gohome">
<center>
<h1 onclick="window.location.reload(true);">Welcome <!-- TODO : add user and app name here --></h1>

<div id="gohome">

	<std-actors v-for="i in actorsList" v-bind:actor="i"></std-actors>
	<img-sensor v-for="j in imgSensorList" v-bind:imgsensor="j"></img-sensor>


	<img-sensor-show v-bind:imgsensorsrc=imgSensorSrc></img-sensor-show>

</div>

<!--
<div id="test" class="test">

</div>
-->



</center>
</body>



</html>


