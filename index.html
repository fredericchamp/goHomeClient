<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<title>goHome</title>
	<meta name="description" content="goHome">
	<meta name="viewport" content="width=device-width">
	<link rel="stylesheet" type="text/css" title="main" href="css/main.css">
	
	<script src="js/jquery.min.js"></script>
	<script src="js/jquery.json.min.js"></script>
	<script src="js/vue.min.js"></script>

	<link rel="stylesheet" href="https://unpkg.com/mint-ui/lib/style.css">
	<script src="https://unpkg.com/mint-ui/lib/index.js"></script>

	<script>
	const cReadCurrentUser = 1
	const cReadActors = 2
	const cReadImgSensor = 3
	const cCallActor = 100

	var vm = {};

	function getObjVal(obj,key){ // TODO : REMOVE
		if ( obj == null ) return '';
		var fieldId=0;
		for (i = 0; i < obj.Fields.length; i++) {
			if (obj.Fields[i].Name == key) {
				fieldId = obj.Fields[i].IdField;
				break;
			}
		}
		if ( fieldId==0 ) {
			return '';
		}
		for (i = 0; i < obj.Values.length; i++) {
			if (obj.Values[i].IdField == fieldId) {
				return obj.Values[i].Val;
			}
		}
		return '';
	};


	function callServer(action,cmde){
		$.post("/api",
		{
			command:$.toJSON(cmde)
		},
		function(data, status){
			switch (action) {
			case cReadCurrentUser:
				vm.currentUser = $.parseJSON(data);
				break;
			case cReadActors:
				vm.actorsList = $.parseJSON(data);
				break;
			case cReadImgSensor:
				vm.imgSensorList = $.parseJSON(data);
				break;
			case cCallActor:
				vm.$toast(cmde.command + '(' + data + ')' );
				break;
			default:
				vm.$toast('callServer : action inconnue (' + action + ')' );
				break;
			}
		});
	};


	function loadAll(){

		// Read actors
		callServer(cReadActors,{
			command:'ReadObject', 
			itemtypeid:3,
			itemid:0,
			objectid:0,
			startts:0,
			endts:0,
			jsonparam:''
		});

		// Read img sensors
		callServer(cReadImgSensor,{
			command:'ReadObject', 
			itemtypeid:5,
			itemid:0,
			objectid:0,
			startts:0,
			endts:0,
			jsonparam:''
		});

	};

// -----------------------------------------------------------------------------------------------------------------------------------------

	$(document).ready(function(){

		Vue.component('goh-header', {
			props: ['user'],
			template: '<mt-header v-bind:title="headertext()"><mt-button icon="back" slot="left"><mt-button icon="more" slot="right"></mt-button></mt-header>',
			computed: {
			}, 
			methods: {
				reload: function () {
					window.location.reload(true);
				},
				headertext:function () {
					return "Welcome " + getObjVal(this.user,"FirstName") + ' (' + getObjVal(this.user,"Email") + ')';
				}
			}
		});

		Vue.component('goh-actors', {
			props: ['actor'],
			template: ' <span class="ico" v-bind:id="actor.Values[0].IdObject" v-on:click="actionner" >  {{getObjVal(actor,"Name")}} \
					<img v-bind:id="actor.Values[0].IdObject" v-bind:src="getObjVal(actor,\'ImgFileName\')" class="icone" /></span>',
			methods: {
				actionner: function (event) {
					var curActor=vm.getObjById(vm.actorsList,event.target.id);
					var showI = ( vm.getObjVal(curActor,'DynParamType')  != '0' );
					var options={confirmButtonText:'Confirmer', cancelButtonText:'Annuler', showInput: showI };
					vm.$messagebox.prompt('Actionner '+ vm.getObjVal(curActor,'Name') + ' ?',options).then(({ value, action }) => {
						callServer(cCallActor,{
							command:'TriggerActor', 
							itemtypeid:0,
							itemid:0,
							objectid:parseInt(event.target.id),
							startts:0,
							endts:0,
							jsonparam:value
						});
					});
				}
			}
		});

		Vue.component('goh-isensor', {
			props: ['imgsensor'],
			template: ' <span class="ico" v-bind:id="imgsensor.Values[0].IdObject" v-on:click="readImg" > {{getObjVal(imgsensor,"Name")}} \
					<img v-bind:id="imgsensor.Values[0].IdObject" v-bind:src="getObjVal(imgsensor,\'ImgFileName\')"  class="icone" /></span>',
			methods: {
				readImg: function (event) {
					$("#showImg").show();
					vm.imgSensorSrc = '/images/PlageMoorea2.jpg'; 
					var obj=vm.getObjById(vm.imgSensorList,event.target.id);
					var url=vm.getObjVal(obj,'Param');
					if ( url == '' ) {
						vm.$toast('URL invalide pour Image sensor ' + event.target.id);
						$("#showImg").hide();
					} else {
						setTimeout(function() { vm.imgSensorSrc = url; }, 100); // For some raison (?) with setTimeout we avoid image caching
						vm.imgSensorSrc = url;  // TODO sometime the img is not upload/diplay
					}
				}
			}
		});

		Vue.component('goh-isensor-show', {
			props: ['imgsensorsrc'],
			template: ' <div id="showImg" class="imgsensor"  v-on:click="hideImg"><img v-bind:src="imgsensorsrc" class="imgsensor"/>\
					<div class="imgsensortitle"> {{imgsensorsrc}} </div></div>', 
			methods: {
				hideImg: function (event) {
					vm.imgSensorSrc = '/images/PlageMoorea.jpg'; 
					$("#showImg").hide();
				}
				// TODO : Save img 
			}
		});


		callServer(cReadCurrentUser,{
			command:'ReadCurrentUser', 
			itemtypeid:0,
			itemid:0,
			objectid:0,
			startts:0,
			endts:0,
			jsonparam:''
		});

		// Read actors
		callServer(cReadActors,{
			command:'ReadObject', 
			itemtypeid:3,
			itemid:0,
			objectid:0,
			startts:0,
			endts:0,
			jsonparam:''
		});

		// Read img sensors
		callServer(cReadImgSensor,{
			command:'ReadObject', 
			itemtypeid:5,
			itemid:0,
			objectid:0,
			startts:0,
			endts:0,
			jsonparam:''
		});

// -----------------------------------------------------------------------------------------------------------------------------------------

		vm = new Vue({
			el: '#gohome',
			data: {
				currentUser: null,
				actorsList: null,
				imgSensorList: null,
				imgSensorSrc: 'images/PlageMoorea.jpg',
				curImgSensor:{},
				selected:'1'
			},
			methods: {
				handleClick: function() {
					this.$toast('Hello world!')
				},
				getObjById: function(obj,id){
					for (i = 0; i < obj.length; i++) {
						if (obj[i].Values[0].IdObject == id) {
							return obj[i];
						}
					}
					return {Fiels:[], Values:[]};
				},
				getObjVal: function(obj,key){
					if ( obj == null ) return '';
					var fieldId=0;
					for (i = 0; i < obj.Fields.length; i++) {
						if (obj.Fields[i].Name == key) {
							fieldId = obj.Fields[i].IdField;
							break;
						}
					}
					if ( fieldId==0 ) {
						return '';
					}
					for (i = 0; i < obj.Values.length; i++) {
						if (obj.Values[i].IdField == fieldId) {
							return obj.Values[i].Val;
						}
					}
					return '';
				}
			}
		});

	});
	</script>
</head>
</head>
<body class="gohome">
<center>
<div id="gohome">

	<goh-header v-bind:user=currentUser></goh-header>

	<goh-actors v-for="i in actorsList" v-bind:actor="i"></goh-actors>
	<goh-isensor v-for="j in imgSensorList" v-bind:imgsensor="j"></goh-isensor>

<br><br><br><br><br><br><br><br><br>

	<goh-isensor-show v-bind:imgsensorsrc=imgSensorSrc></goh-isensor-show>

</div>

<!--
<div id="test" class="test">

</div>
-->



</center>
</body>
</html>


